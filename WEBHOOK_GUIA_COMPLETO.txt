‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë         üöÄ GUIA COMPLETO - DEPLOY AUTOM√ÅTICO                  ‚ïë
‚ïë         M&N Terapeutas - GitHub Webhook                       ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

============================================
üìã RESUMO DO PROBLEMA
============================================

O VPS n√£o estava recebendo commits automaticamente porque:

1. ‚ùå Webhook do GitHub n√£o estava configurado
2. ‚ùå Servidor webhook n√£o estava rodando
3. ‚ùå Servi√ßo systemd n√£o estava criado
4. ‚ùå Nginx n√£o estava configurado para proxy reverso

SOLU√á√ÉO: Implementamos um servidor webhook robusto com:
‚úÖ Verifica√ß√£o de assinatura SHA256
‚úÖ Suporte a m√∫ltiplos eventos do GitHub
‚úÖ Logging detalhado
‚úÖ Tratamento de erros
‚úÖ Servi√ßo systemd para auto-restart
‚úÖ Nginx como proxy reverso

============================================
üöÄ PASSO 1: COPIAR ARQUIVOS PARA O VPS
============================================

1. Conecte ao VPS:
   ssh root@31.97.252.100

2. Navegue para o diret√≥rio do projeto:
   cd /var/www/mn

3. Copie o arquivo webhook-server.js:
   # Op√ß√£o A: Via SCP (do seu computador local)
   scp webhook-server.js root@31.97.252.100:/var/www/mn/

   # Op√ß√£o B: Criar direto no VPS
   cat > /var/www/mn/webhook-server.js << 'EOF'
   [Cole aqui o conte√∫do do arquivo webhook-server.js]
   EOF

4. Copie o script de setup:
   scp WEBHOOK_SETUP_FINAL.sh root@31.97.252.100:/var/www/mn/

============================================
üîß PASSO 2: EXECUTAR SCRIPT DE SETUP
============================================

1. Conecte ao VPS:
   ssh root@31.97.252.100

2. Navegue para o diret√≥rio:
   cd /var/www/mn

3. D√™ permiss√£o de execu√ß√£o:
   chmod +x WEBHOOK_SETUP_FINAL.sh

4. Execute o script:
   ./WEBHOOK_SETUP_FINAL.sh

   Este script ir√°:
   ‚úÖ Criar usu√°rio webhook
   ‚úÖ Configurar permiss√µes
   ‚úÖ Criar servi√ßo systemd
   ‚úÖ Configurar Nginx como proxy reverso
   ‚úÖ Configurar firewall
   ‚úÖ Testar webhook

5. Aguarde a conclus√£o (deve levar ~1 minuto)

============================================
üîê PASSO 3: CONFIGURAR WEBHOOK NO GITHUB
============================================

1. Acesse: https://github.com/krtur/mn/settings/hooks

2. Clique em "Add webhook"

3. Preencha os campos:

   üìç Payload URL:
      http://31.97.252.100:9000/hooks/mn-deploy

   üìã Content type:
      application/json

   üîë Secret:
      c07e7eaa5d8bab70edf4b3acb837f9426ce96fbbd12ee2b270821cecb11b19b8

   üì® Which events would you like to trigger this webhook?
      ‚óã Just the push event (SELECIONE ESTA OP√á√ÉO)

   ‚úÖ Active:
      [X] Active (MARQUE ESTA CAIXA)

4. Clique em "Add webhook"

5. Voc√™ ver√° uma tela com a lista de webhooks
   Procure por "http://31.97.252.100:9000/hooks/mn-deploy"
   Deve mostrar um ‚úÖ verde indicando sucesso

============================================
üß™ PASSO 4: TESTAR WEBHOOK
============================================

TESTE 1: Health Check (do seu computador)
   curl http://31.97.252.100:9000/health

   Resposta esperada:
   {"status":"ok","timestamp":"2025-01-01T12:00:00.000Z"}

TESTE 2: Deploy Manual (do seu computador)
   curl -X POST http://31.97.252.100:9000/hooks/test

   Resposta esperada:
   {"success":true,"message":"Deploy conclu√≠do com sucesso"}

TESTE 3: Verificar Logs (no VPS)
   ssh root@31.97.252.100
   journalctl -u webhook -f

   Voc√™ deve ver logs como:
   [timestamp] üöÄ INICIANDO DEPLOY AUTOM√ÅTICO
   [timestamp] üì• Fazendo git pull origin main...
   [timestamp] üì¶ Instalando depend√™ncias...
   [timestamp] üî® Fazendo build...
   [timestamp] ‚úÖ DEPLOY CONCLU√çDO COM SUCESSO!

TESTE 4: Deploy Autom√°tico (do GitHub)
   1. Fa√ßa um commit vazio:
      git commit -m "teste deploy autom√°tico" --allow-empty

   2. Fa√ßa push:
      git push origin main

   3. Aguarde 2-3 minutos

   4. Verifique os logs no VPS:
      ssh root@31.97.252.100
      journalctl -u webhook -f

   5. Recarregue o site:
      http://31.97.252.100

============================================
üìä MONITORAMENTO E LOGS
============================================

VER STATUS DO WEBHOOK:
   systemctl status webhook

VER LOGS EM TEMPO REAL:
   journalctl -u webhook -f

VER √öLTIMOS 50 LOGS:
   journalctl -u webhook -n 50

VER LOGS DE HOJE:
   journalctl -u webhook --since today

VER LOGS COM FILTRO:
   journalctl -u webhook | grep "DEPLOY"

PARAR WEBHOOK:
   systemctl stop webhook

REINICIAR WEBHOOK:
   systemctl restart webhook

INICIAR WEBHOOK:
   systemctl start webhook

============================================
üîç TROUBLESHOOTING
============================================

PROBLEMA: Webhook n√£o responde
SOLU√á√ÉO:
   1. Verifique se o servi√ßo est√° rodando:
      systemctl status webhook
   
   2. Verifique se a porta 9000 est√° aberta:
      netstat -tlnp | grep 9000
   
   3. Verifique os logs:
      journalctl -u webhook -n 20
   
   4. Reinicie o webhook:
      systemctl restart webhook

PROBLEMA: Deploy n√£o executa ap√≥s push
SOLU√á√ÉO:
   1. Verifique se o webhook est√° configurado no GitHub:
      https://github.com/krtur/mn/settings/hooks
   
   2. Clique no webhook e v√° para "Recent Deliveries"
   
   3. Veja se h√° erros na entrega
   
   4. Teste manualmente:
      curl -X POST http://31.97.252.100:9000/hooks/test
   
   5. Verifique os logs:
      journalctl -u webhook -f

PROBLEMA: Erro "Assinatura inv√°lida"
SOLU√á√ÉO:
   1. Verifique se o secret est√° correto:
      c07e7eaa5d8bab70edf4b3acb837f9426ce96fbbd12ee2b270821cecb11b19b8
   
   2. Copie exatamente este valor no GitHub
   
   3. N√£o adicione espa√ßos ou caracteres extras
   
   4. Salve e tente novamente

PROBLEMA: Erro "git pull" falha
SOLU√á√ÉO:
   1. Verifique se o reposit√≥rio est√° clonado:
      ls -la /var/www/mn/.git
   
   2. Verifique se tem permiss√£o:
      ls -la /var/www/mn | head -5
   
   3. Teste git pull manualmente:
      cd /var/www/mn
      git pull origin main
   
   4. Se falhar, veja o erro e corrija

PROBLEMA: npm install falha
SOLU√á√ÉO:
   1. Verifique se Node.js est√° instalado:
      node --version
      npm --version
   
   2. Limpe o cache do npm:
      npm cache clean --force
   
   3. Tente instalar novamente:
      cd /var/www/mn
      npm install
   
   4. Se persistir, verifique o arquivo package.json

PROBLEMA: npm run build falha
SOLU√á√ÉO:
   1. Verifique se h√° erros de TypeScript:
      npm run build 2>&1 | tail -20
   
   2. Corrija os erros no c√≥digo
   
   3. Fa√ßa commit e push novamente

PROBLEMA: Nginx n√£o reinicia
SOLU√á√ÉO:
   1. Teste a configura√ß√£o:
      nginx -t
   
   2. Se houver erro, corrija a configura√ß√£o:
      nano /etc/nginx/sites-available/mn
   
   3. Reinicie:
      systemctl restart nginx
   
   4. Verifique status:
      systemctl status nginx

============================================
üìà FLUXO COMPLETO DE DEPLOY
============================================

1. Voc√™ faz altera√ß√µes no c√≥digo localmente
   ‚Üì
2. Faz commit:
   git commit -m "descri√ß√£o da altera√ß√£o"
   ‚Üì
3. Faz push:
   git push origin main
   ‚Üì
4. GitHub recebe o push
   ‚Üì
5. GitHub envia notifica√ß√£o para o webhook:
   POST http://31.97.252.100:9000/hooks/mn-deploy
   ‚Üì
6. Webhook verifica a assinatura SHA256
   ‚Üì
7. Webhook executa os comandos:
   - git pull origin main
   - npm install
   - npm run build
   - pm2 restart mn-backend
   - systemctl restart nginx
   ‚Üì
8. Site √© atualizado automaticamente
   ‚Üì
9. Voc√™ acessa http://31.97.252.100 e v√™ as mudan√ßas

‚è±Ô∏è Tempo total: ~2-3 minutos

============================================
üîê SEGURAN√áA
============================================

‚úÖ IMPLEMENTADO:
   - Verifica√ß√£o de assinatura SHA256
   - Valida√ß√£o de branch (apenas main)
   - Valida√ß√£o de evento (apenas push)
   - Logs detalhados de todas as a√ß√µes
   - Usu√°rio dedicado para o webhook
   - Permiss√µes restritivas

üîú MELHORIAS FUTURAS:
   - [ ] Adicionar SSL/HTTPS (Let's Encrypt)
   - [ ] Configurar dom√≠nio pr√≥prio
   - [ ] Implementar rate limiting
   - [ ] Adicionar autentica√ß√£o adicional
   - [ ] Backup autom√°tico antes do deploy
   - [ ] Rollback autom√°tico em caso de erro

============================================
üìö ARQUIVOS CRIADOS
============================================

1. webhook-server.js
   - Servidor Node.js que recebe webhooks do GitHub
   - Verifica assinatura SHA256
   - Executa script de deploy
   - Logging detalhado

2. WEBHOOK_SETUP_FINAL.sh
   - Script de instala√ß√£o e configura√ß√£o
   - Cria servi√ßo systemd
   - Configura Nginx
   - Configura firewall

3. WEBHOOK_GUIA_COMPLETO.txt
   - Este arquivo
   - Guia passo a passo
   - Troubleshooting
   - Refer√™ncia r√°pida

============================================
‚úÖ CHECKLIST FINAL
============================================

[  ] Copiar webhook-server.js para o VPS
[  ] Copiar WEBHOOK_SETUP_FINAL.sh para o VPS
[  ] Executar WEBHOOK_SETUP_FINAL.sh
[  ] Verificar se webhook est√° rodando: systemctl status webhook
[  ] Testar health check: curl http://31.97.252.100:9000/health
[  ] Configurar webhook no GitHub
[  ] Testar com commit vazio
[  ] Verificar logs: journalctl -u webhook -f
[  ] Recarregar site e verificar mudan√ßas
[  ] Documentar configura√ß√£o

============================================
üéâ PRONTO!
============================================

Seu VPS agora tem deploy autom√°tico funcionando!

Sempre que voc√™ fizer push no GitHub:
1. GitHub notifica o webhook
2. Webhook executa o deploy
3. Site √© atualizado automaticamente

Qualquer d√∫vida, consulte os logs:
   journalctl -u webhook -f

Bom trabalho! üöÄ
