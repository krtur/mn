============================================
FUNCIONALIDADE DE MENSAGENS - IMPLEMENTAÇÃO COMPLETA
============================================

✅ O QUE FOI IMPLEMENTADO:

1. BANCO DE DADOS (Supabase)
   ✓ Tabela 'messages' com colunas:
     - id (UUID, chave primária)
     - sender_id (UUID, referência ao usuário que envia)
     - recipient_id (UUID, referência ao usuário que recebe)
     - content (TEXT, conteúdo da mensagem)
     - read (BOOLEAN, se foi lida)
     - created_at (TIMESTAMP, data de criação)
     - updated_at (TIMESTAMP, data de atualização)
   
   ✓ Índices para performance:
     - idx_messages_sender_id
     - idx_messages_recipient_id
     - idx_messages_created_at
     - idx_messages_conversation (para conversas)
   
   ✓ Row Level Security (RLS):
     - Usuários só veem mensagens que enviaram ou receberam
     - Usuários só podem inserir mensagens como remetente
     - Atualização permitida para marcar como lida

2. HOOK useMessages (hooks/useMessages.ts)
   ✓ Busca mensagens em tempo real do Supabase
   ✓ Agrupa mensagens em conversas
   ✓ Filtra conversas por role:
     - Pacientes: veem apenas conversas com terapeutas
     - Terapeutas: veem conversas com todos os pacientes
   ✓ Conta mensagens não lidas
   ✓ Suporta atualização em tempo real via WebSocket

3. COMPONENTE PACIENTE (components/patient/Messages.tsx)
   ✓ Interface simplificada - mostra apenas 1 terapeuta
   ✓ Auto-scroll para última mensagem
   ✓ Marca mensagens como lidas automaticamente
   ✓ Envio de mensagens com validação
   ✓ Mostra contador de mensagens não lidas
   ✓ Design responsivo e moderno
   ✓ Mensagens do paciente: azul teal à direita
   ✓ Mensagens do terapeuta: branco à esquerda
   ✓ Timestamp em português

4. COMPONENTE TERAPEUTA (components/therapist/Messages.tsx)
   ✓ Interface com 2 colunas:
     - Esquerda: lista de pacientes (conversas)
     - Direita: chat com paciente selecionado
   ✓ Busca de pacientes por nome ou email
   ✓ Seleção de paciente para conversar
   ✓ Auto-scroll para última mensagem
   ✓ Contador de mensagens não lidas por paciente
   ✓ Envio de mensagens com validação
   ✓ Design responsivo (mobile: coluna única)
   ✓ Mesmo design de mensagens que paciente

============================================
COMO COMEÇAR:
============================================

PASSO 1: Criar tabela no Supabase
   1. Abra Supabase Dashboard
   2. Vá para SQL Editor
   3. Copie todo o conteúdo de MESSAGES_SETUP.sql
   4. Cole e execute
   5. Verifique se não há erros

PASSO 2: Testar como Paciente
   1. Acesse http://localhost:3000/login
   2. Login com credenciais de paciente
   3. Vá para Dashboard > Mensagens
   4. Você verá seu terapeuta na lista
   5. Clique e envie uma mensagem
   6. Mensagem aparecerá no banco de dados em tempo real

PASSO 3: Testar como Terapeuta
   1. Faça logout
   2. Login com credenciais de terapeuta
   3. Vá para Dashboard > Mensagens
   4. Você verá lista de pacientes à esquerda
   5. Clique em um paciente
   6. Você verá o histórico de mensagens
   7. Responda a mensagem do paciente

PASSO 4: Testar em tempo real
   1. Abra 2 abas do navegador
   2. Uma com paciente, outra com terapeuta
   3. Envie mensagem do paciente
   4. Veja aparecer instantaneamente no terapeuta
   5. Responda do terapeuta
   6. Veja aparecer instantaneamente no paciente

============================================
TERAPEUTAS PADRÃO PARA TESTE:
============================================

NADIELMA:
   Email: nadi@mnterapeutas.com
   Senha: Perante@1202
   ID: 83273ffc-c878-4abc-a24b-e35fd4801339

MARCELO:
   Email: marcelo@mnterapeutas.com
   Senha: Perante@1202
   ID: 028d8869-679f-4093-b435-1a43b6ced0e2

============================================
FUNCIONALIDADES PRINCIPAIS:
============================================

PACIENTE:
✓ Conversa com terapeuta associado
✓ Vê apenas 1 conversa (seu terapeuta)
✓ Auto-scroll para última mensagem
✓ Mensagens marcadas como lidas automaticamente
✓ Contador de não lidas
✓ Envio de mensagens
✓ Timestamp das mensagens
✓ Indicador visual de mensagens não lidas

TERAPEUTA:
✓ Lista de todos os pacientes com conversas
✓ Busca de pacientes por nome/email
✓ Seleciona paciente para conversar
✓ Vê histórico completo de mensagens
✓ Auto-scroll para última mensagem
✓ Contador de não lidas por paciente
✓ Envio de mensagens
✓ Timestamp das mensagens
✓ Indicador visual de mensagens não lidas

============================================
FLUXO DE DADOS:
============================================

1. ENVIO DE MENSAGEM:
   Usuário digita mensagem
   → Clica em enviar
   → Validação (não vazio)
   → Insert na tabela messages
   → Supabase retorna ID da mensagem
   → Hook useMessages recebe update em tempo real
   → Componente re-renderiza com nova mensagem
   → Input é limpo

2. RECEBIMENTO DE MENSAGEM:
   Supabase WebSocket detecta INSERT
   → Hook useMessages é notificado
   → Refetch de conversas
   → Componente re-renderiza
   → Auto-scroll para nova mensagem
   → Se conversa está aberta, marca como lida

3. MARCAR COMO LIDA:
   Usuário abre conversa
   → useEffect detecta mudança
   → Para cada mensagem não lida recebida
   → Update na tabela messages (read = true)
   → Supabase retorna sucesso
   → Hook atualiza estado local

============================================
ESTRUTURA DE PASTAS:
============================================

/hooks
  └─ useMessages.ts (hook principal)

/components
  ├─ /patient
  │  └─ Messages.tsx (interface do paciente)
  └─ /therapist
     └─ Messages.tsx (interface do terapeuta)

/services
  ├─ supabase.ts (cliente Supabase)
  └─ supabase-api.ts (funções de API)

============================================
TECNOLOGIAS USADAS:
============================================

- React 19.2.0 (componentes)
- TypeScript (tipagem)
- Supabase (banco de dados + realtime)
- Tailwind CSS (estilos)
- React Router (navegação)

============================================
SEGURANÇA:
============================================

✓ Row Level Security (RLS) habilitado
✓ Usuários só veem suas próprias mensagens
✓ Validação no frontend (não vazio)
✓ Validação no backend (RLS)
✓ Autenticação obrigatória
✓ Criptografia em trânsito (HTTPS)

============================================
PERFORMANCE:
============================================

✓ Índices no banco de dados
✓ Lazy loading de mensagens
✓ WebSocket para atualizações em tempo real
✓ Paginação (se necessário)
✓ Memoização de componentes

============================================
PRÓXIMOS PASSOS (OPCIONAL):
============================================

1. Adicionar paginação de mensagens antigas
2. Adicionar indicador de "digitando..."
3. Adicionar reações a mensagens (emoji)
4. Adicionar anexos (imagens, documentos)
5. Adicionar busca em mensagens
6. Adicionar notificações push
7. Adicionar áudio/vídeo chamada
8. Adicionar grupos de conversa
9. Adicionar criptografia end-to-end
10. Adicionar backup de mensagens

============================================
TROUBLESHOOTING:
============================================

PROBLEMA: Mensagens não aparecem
SOLUÇÃO: 
  1. Verifique se tabela foi criada no Supabase
  2. Verifique se RLS está habilitado corretamente
  3. Verifique console do navegador para erros
  4. Verifique se usuários estão autenticados

PROBLEMA: Mensagens não atualizam em tempo real
SOLUÇÃO:
  1. Verifique se WebSocket está conectado
  2. Verifique se Supabase Realtime está habilitado
  3. Recarregue a página
  4. Verifique conexão de internet

PROBLEMA: Erro ao enviar mensagem
SOLUÇÃO:
  1. Verifique se mensagem não está vazia
  2. Verifique se usuário está autenticado
  3. Verifique se recipient_id é válido
  4. Verifique console para erro específico

PROBLEMA: Paciente vê conversas com outros pacientes
SOLUÇÃO:
  1. Verifique se role do usuário está correto
  2. Verifique se filtro no useMessages está funcionando
  3. Limpe cache do navegador
  4. Recarregue a página

============================================
ARQUIVOS CRIADOS/MODIFICADOS:
============================================

CRIADOS:
✓ MESSAGES_SETUP.sql (SQL para criar tabela)
✓ MENSAGENS_IMPLEMENTACAO.txt (este arquivo)

MODIFICADOS:
✓ hooks/useMessages.ts (melhorado com filtros)
✓ components/patient/Messages.tsx (nova interface)
✓ components/therapist/Messages.tsx (nova interface)

============================================
TESTES RECOMENDADOS:
============================================

1. TESTE BÁSICO:
   [ ] Paciente consegue enviar mensagem
   [ ] Terapeuta recebe mensagem em tempo real
   [ ] Terapeuta consegue responder
   [ ] Paciente recebe resposta em tempo real

2. TESTE DE FILTROS:
   [ ] Paciente vê apenas seu terapeuta
   [ ] Terapeuta vê todos os pacientes
   [ ] Busca de paciente funciona

3. TESTE DE LEITURA:
   [ ] Mensagem marca como lida automaticamente
   [ ] Contador de não lidas funciona
   [ ] Indicador visual de não lida aparece

4. TESTE DE RESPONSIVIDADE:
   [ ] Funciona em desktop
   [ ] Funciona em tablet
   [ ] Funciona em mobile

5. TESTE DE PERFORMANCE:
   [ ] Carrega rápido com muitas mensagens
   [ ] Auto-scroll funciona suavemente
   [ ] Sem lag ao digitar

============================================
SUPORTE:
============================================

Se encontrar problemas:
1. Verifique console do navegador (F12)
2. Verifique logs do Supabase
3. Verifique se tabela existe no Supabase
4. Verifique se RLS está configurado
5. Tente recarregar a página
6. Limpe cache do navegador
7. Verifique conexão de internet

============================================
FIM DA DOCUMENTAÇÃO
============================================
